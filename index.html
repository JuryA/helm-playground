<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Helm Playground</title>
    <link rel="stylesheet" href="codemirror/codemirror.css" />
    <link rel="stylesheet" href="codemirror/elegant.css" />
    <link rel="stylesheet" href="codemirror/material.css" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="app">
      <div class="top">
        <a class="logo" href="/">Helm-playground.com</a>
      </div>
      <div class="content">
        <div class="column">
          <div class="label">template.yaml</div>
          <textarea class="textarea textarea--template"></textarea>
        </div>
        <div class="column">
          <div class="label">values.yaml</div>
          <textarea class="textarea textarea--values"></textarea>
        </div>
        <div class="column">
          <div class="label">output</div>
          <textarea class="textarea textarea--output" readonly></textarea>
        </div>
        <div class="overlay">
          <p><button class="start">Start playground</button></p>
          <p><strong>Debug Helm-templates in your browser</strong></p>
          <p class="overlay__dim">
            A 8MB WebAssembly-file will be downloaded. It includes Sprig, which
            Helm uses for templating. Source on
            <a href="https://github.com/shipmight/helm-playground">GitHub</a>.
          </p>
        </div>
        <div class="error" style="display: none"></div>
      </div>
    </div>
    <script src="codemirror/codemirror.js"></script>
    <script src="codemirror/yaml.js"></script>
    <script src="codemirror/placeholder.js"></script>
    <script src="dist/wasm_exec.js"></script>
    <script src="lib.js"></script>
    <script>
      const defaultTemplateYaml =
        '---\nexample: {{ .Values.items | toYaml | nindent 2 }}\n';
      const defaultValuesYaml = '---\nitems: ["first", "second"]\n';
      const defaultOutput = '---\nexample: \n  - first\n  - second\n';

      const templateTextarea = document.querySelector('.textarea--template');
      const valuesTextarea = document.querySelector('.textarea--values');
      const outputTextarea = document.querySelector('.textarea--output');

      templateTextarea.value = defaultTemplateYaml;
      valuesTextarea.value = defaultValuesYaml;
      outputTextarea.value = defaultOutput;

      const lightTheme = 'elegant';
      const darkTheme = 'material';

      const isDark =
        window.matchMedia &&
        window.matchMedia('(prefers-color-scheme: dark)').matches;

      const codeMirrorOptions = {
        mode: 'yaml',
        theme: isDark ? darkTheme : lightTheme,
      };

      const templateCodeMirror = CodeMirror.fromTextArea(templateTextarea, {
        ...codeMirrorOptions,
        placeholder: 'Copy your Helm template here',
      });
      const valuesCodeMirror = CodeMirror.fromTextArea(valuesTextarea, {
        ...codeMirrorOptions,
        placeholder: 'Copy your values YAML here',
      });
      const outputCodeMirror = CodeMirror.fromTextArea(outputTextarea, {
        ...codeMirrorOptions,
        placeholder: 'Generated output will show up here',
      });

      window
        .matchMedia('(prefers-color-scheme: dark)')
        .addEventListener('change', (event) => {
          const theme = event.matches ? darkTheme : lightTheme;
          templateCodeMirror.setOption('theme', theme);
          valuesCodeMirror.setOption('theme', theme);
          outputCodeMirror.setOption('theme', theme);
        });

      const overlay = document.querySelector('.overlay');
      const startButton = document.querySelector('.start');
      const errorNotification = document.querySelector('.error');

      startButton.addEventListener('click', () => {
        startButton.disabled = true;
        startButton.textContent = 'Loadingâ€¦';

        window
          .loadGetYaml()
          .then((getYaml) => {
            overlay.style.display = 'none';

            const onChange = () => {
              const templateValue = templateCodeMirror.getValue();
              const valuesValue = valuesCodeMirror.getValue();

              const { yaml, err } = getYaml(templateValue, valuesValue);

              if (err) {
                errorNotification.style.display = 'block';
                errorNotification.textContent = err;
              } else {
                errorNotification.style.display = 'none';
                outputCodeMirror.setValue(yaml);
              }
            };

            templateCodeMirror.on('change', onChange);
            valuesCodeMirror.on('change', onChange);
          })
          .catch((error) => {
            console.error(error);
          });
      });
    </script>
  </body>
</html>
