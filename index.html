<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Helm Playground</title>
    <link rel="stylesheet" href="codemirror/codemirror.css" />
    <link rel="stylesheet" href="codemirror/elegant.css" />
    <link rel="stylesheet" href="codemirror/material.css" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="app">
      <div class="top">
        <a class="logo" href="/">Helm-playground.com</a>
      </div>
      <div class="content">
        <div class="column">
          <div class="label">template.yaml</div>
          <textarea class="textarea textarea--template"></textarea>
        </div>
        <div class="column">
          <div class="label">values.yaml</div>
          <textarea class="textarea textarea--values"></textarea>
        </div>
        <div class="column">
          <div class="label">output</div>
          <textarea class="textarea textarea--output" readonly></textarea>
        </div>
        <div class="overlay">
          <p><button class="start">Start playground</button></p>
          <p><strong>Debug Helm-templates in your browser</strong></p>
          <p class="overlay__dim">
            A WebAssembly-file (2.3MB gzipped) will be downloaded and cached by
            your browser. It includes Sprig, which Helm uses for templating.
            Source on
            <a href="https://github.com/codeclown/helm-playground">GitHub</a>.
          </p>
        </div>
        <div class="error" style="display: none"></div>
      </div>
    </div>
    <script src="codemirror/codemirror.js"></script>
    <script src="codemirror/yaml.js"></script>
    <script src="codemirror/placeholder.js"></script>
    <script src="lz-string.js"></script>
    <script src="dist/wasm_exec.js"></script>
    <script src="lib.js"></script>
    <script>
      const compress = LZString.compressToEncodedURIComponent;
      const decompress = LZString.decompressFromEncodedURIComponent;
      const updateHash = (templateValue, valuesValue) => {
        const hashParams = new URLSearchParams();
        hashParams.append("t", compress(templateValue));
        hashParams.append("v", compress(valuesValue));
        const hash = hashParams.toString();
        window.history.replaceState(null, "", `#${hash}`);
      };
      const readHash = () => {
        const hashContent = window.location.hash.slice(1);
        if (hashContent === "") {
          return;
        }
        const params = new URLSearchParams(hashContent);
        const templateValue = decompress(params.get("t"));
        const valuesValue = decompress(params.get("v"));
        return { templateValue, valuesValue };
      };

      let defaultTemplateYaml =
        "---\nexample: {{ .Values.items | toYaml | nindent 2 }}\n";
      let defaultValuesYaml = '---\nitems: ["first", "second"]\n';
      let defaultOutput = "---\nexample: \n  - first\n  - second\n";

      const fromHash = readHash();
      if (fromHash) {
        defaultTemplateYaml = fromHash.templateValue;
        defaultValuesYaml = fromHash.valuesValue;
        defaultOutput = "";
      }

      const templateTextarea = document.querySelector(".textarea--template");
      const valuesTextarea = document.querySelector(".textarea--values");
      const outputTextarea = document.querySelector(".textarea--output");

      templateTextarea.value = defaultTemplateYaml;
      valuesTextarea.value = defaultValuesYaml;
      outputTextarea.value = defaultOutput;

      const lightTheme = "elegant";
      const darkTheme = "material";

      const isDark =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      const codeMirrorOptions = {
        mode: "yaml",
        theme: isDark ? darkTheme : lightTheme,
      };

      const templateCodeMirror = CodeMirror.fromTextArea(templateTextarea, {
        ...codeMirrorOptions,
        placeholder: "Copy your Helm template here",
      });
      const valuesCodeMirror = CodeMirror.fromTextArea(valuesTextarea, {
        ...codeMirrorOptions,
        placeholder: "Copy your values YAML here",
      });
      const outputCodeMirror = CodeMirror.fromTextArea(outputTextarea, {
        ...codeMirrorOptions,
        placeholder: "Generated output will show up here",
      });

      templateTextarea.CodeMirror = templateCodeMirror;
      valuesTextarea.CodeMirror = valuesCodeMirror;
      outputTextarea.CodeMirror = outputCodeMirror;

      window
        .matchMedia("(prefers-color-scheme: dark)")
        .addEventListener("change", (event) => {
          const theme = event.matches ? darkTheme : lightTheme;
          templateCodeMirror.setOption("theme", theme);
          valuesCodeMirror.setOption("theme", theme);
          outputCodeMirror.setOption("theme", theme);
        });

      const overlay = document.querySelector(".overlay");
      const startButton = document.querySelector(".start");
      const errorNotification = document.querySelector(".error");

      const formatError = (err) => {
        err = err.replace("template: ", "template.yaml - ");
        err = err.replace("yaml: ", "values.yaml - ");
        return err;
      };

      startButton.addEventListener("click", () => {
        startButton.disabled = true;
        startButton.textContent = "Loadingâ€¦";

        window
          .loadGetYaml()
          .then((getYaml) => {
            overlay.style.display = "none";

            const onChange = () => {
              const templateValue = templateCodeMirror.getValue();
              const valuesValue = valuesCodeMirror.getValue();

              const { yaml, err } = getYaml(templateValue, valuesValue);

              if (err) {
                errorNotification.style.display = "block";
                errorNotification.textContent = formatError(err);
              } else {
                errorNotification.style.display = "none";
                outputCodeMirror.setValue(yaml);
              }

              updateHash(templateValue, valuesValue);
            };

            templateCodeMirror.on("change", onChange);
            valuesCodeMirror.on("change", onChange);
            onChange();
          })
          .catch((error) => {
            console.error(error);
          });
      });
    </script>
  </body>
</html>
